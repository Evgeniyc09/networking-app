<!--#set var="title" value="OptimizedHTML 5" -->
<!--#include virtual="./parts/header.html" -->
<div class="page page__bg page__compas">
  <!--#include virtual="./parts/head.html" -->

  <div id="map"></div>
  <div class="rotatable" id="rotatable">

    <img src="../images/dist/plan-example.png" alt="">
  </div>
  <div id="compass-wrap">
    <svg id="compass-svg" width="360" height="360" viewBox="0 0 360 360">
      <!-- Картинка компаса -->
      <g id="compass-group">
        a
        <image href="../images/dist/compas.png" x="0" y="0" width="360" height="360" />
      </g>
      <!-- Красный курсор (стрелка) -->
      <g id="cursor-group">
        <line x1="180" y1="180" x2="180" y2="0" stroke="red" stroke-width="3" stroke-linecap="round" />
        <!-- Горизонтальная перекладина в центре -->
        <line x1="140" y1="180" x2="220" y2="180" stroke="red" stroke-width="3" stroke-linecap="round" />
        <!-- Прямоугольник (голова с градусом) -->
        <rect id="cursor-head" x="155" y="0" width="50" height="32" rx="6" fill="red" />
        <!-- Текст угла -->
        <text id="cursor-angle-label" x="180" y="20" text-anchor="middle" fill="white" font-size="20"
          font-family="sans-serif" alignment-baseline="middle" font-weight="bold">0°</text>
      </g>


    </svg>
  </div>
  <div class="compass-back">

    <div class="compass-back__items">
      <div class="compass-sectors-wrapper"></div>
      <div id="n" class="compass-back__item compass-back__item--1">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>
      <div id="ne" class="compass-back__item compass-back__item--2">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="e" class="compass-back__item compass-back__item--3">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="se" class="compass-back__item compass-back__item--4">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="s" class="compass-back__item compass-back__item--5">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="sw" class="compass-back__item compass-back__item--6">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="w" class="compass-back__item compass-back__item--7">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="nw" class="compass-back__item compass-back__item--8">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="center" class="compass-back__item compass-back__item--center">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>
    </div>
  </div>
  <a href="" class="compass__settings-btn" data-modal-open="modalExample">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"
      class="lucide lucide-settings2-icon lucide-settings-2">
      <path d="M14 17H5" />
      <path d="M19 7h-9" />
      <circle cx="17" cy="17" r="3" />
      <circle cx="7" cy="7" r="3" />
    </svg>
    Параметры
  </a>
  <div id="modalExample" class="modal">
    <div class="modal__overlay" data-modal-close></div>
    <div class="modal__content" data-city-search="from" data-hidden-input="#hidden-from">
      <button class="modal__close" data-modal-close></button>
      <h2 class="modal__title">Параметры</h2>
      <div id="ui" class="compass-field-wrapper">
        <label for="compass-angle">Повернуть компас:</label> <input id="compass-angle" class="compass-field"
          type="number" value="0" step="1" min="0" max="359"> °
      </div>
      <div class="compass-field-wrapper">
        <label for="CSYear">Текущий год:</label> <input id="CSYear" class="compass-field" type="number" step="1"
          value="2023">
      </div>
      <!-- <div class="compass-field-wrapper">
        <label for="rangePicker">Текущий месяц:</label> <input type="text" id="rangePicker" class="compass-field"
          placeholder="Дата" readonly>
      </div> -->
      <div class="compass-field-wrapper">
        <label for="CSMonth">Текущий месяц:</label>

        <select name="" id="CSMonth" class="compass-field">
          <option value="">12/08</option>
          <option value="">12/08</option>
          <option value="">12/08</option>
          <option value="">12/08</option>
        </select>
      </div>
      <div class="compass-field-wrapper">
        <label for="builtYear">Год постройки:</label> <input id="builtYear" class="compass-field" type="number" step="1"
          value="2023">
      </div>
      <div id="DegreeCorret" class="FormBlock">

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="FStarsN" name="FStarsN" checked>
          <label for="FStarsN">Натальные летящие звезды</label>
        </div>

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="FStarsY" name="FStarsY" checked>
          <label for="FStarsY">Текущие звезды <b>года</b></label>
        </div>

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="FStarsM" name="FStarsM" checked>
          <label for="FStarsM">Текущие звезды <b>месяца</b></label>
        </div>

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="FStarsC" name="FStarsC">
          <label for="FStarsC">Центральные летящие звезды</label>
        </div>
        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="fiveYM" name="fiveYM">
          <label for="fiveYM">Направления 5 года и месяца</label>
        </div>

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="TaiSui" name="TaiSui">
          <label for="TaiSui">Тай Суй и Суй По</label>
        </div>

      </div>

      <label class="file-label">
        <input type="file" class="file-input">
        <span class="file-custom">Загрузить план</span>
      </label>
      <button class="modal__save-btn" data-modal-close>Сохранить</button>
      <button class="modal__close" data-modal-close></button>
    </div>
  </div>
  <!--#include virtual="./parts/nav.html" -->
</div>
<!--#include virtual="./parts/footer.html" -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=21e9bb68-c626-48cd-9ec6-caba33922726&lang=ru_RU"
  type="text/javascript"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const replacementStarsUrl = './starsMockData.json';
    let map;
    let cursorAngle = 0;
    let starsData = null;

    function fetchCompassDataOnce(coords, cursorAngle) {
      const period = 9;
      const year = 2025;
      const month = 2;

      fetch(`${replacementStarsUrl}?period=${period}&year=${year}&month=${month}`)
        .then(response => {
          if (!response.ok) throw new Error('Ошибка загрузки звёзд');
          return response.json();
        })
        .then(data => {
          starsData = data;
          setCursorAngle(cursorAngle);
          updateFiveYMHighlight();
          updateTaiSuiHighlight();
        })
        .catch(err => {
          console.error('Ошибка получения данных:', err);
        });
    }

    function getSectorFromAngle(angle) {
      const sectors = [
        's1', 's2', 's3',
        'sw1', 'sw2', 'sw3',
        'w1', 'w2', 'w3',
        'nw1', 'nw2', 'nw3',
        'n1', 'n2', 'n3',
        'ne1', 'ne2', 'ne3',
        'e1', 'e2', 'e3',
        'se1', 'se2', 'se3'
      ];

      const index = Math.floor((angle % 360) / 15);
      return sectors[index] || 's1';
    }

    function transformStarsToCompassArray(starsRaw, years, months, sectorKey) {
      const directionOrder = ['n', 'ne', 'e', 'se', 's', 'sw', 'w', 'nw', 'center'];
      const cursorData = starsRaw[sectorKey];
      if (!cursorData) return [];
      return directionOrder.map(dir => ({
        sector: dir,
        values: cursorData[dir] || [],
        year: years[dir],
        month: months[dir]
      }));
    }

    function fillCompassItems(stars) {
      stars.forEach(star => {
        const item = document.getElementById(`${star.sector}`);
        if (!item) return;
        const flyStar = item.querySelector('.fly-star');
        if (!flyStar) return;

        flyStar.innerHTML = '';

        star.values.forEach(val => {
          const span = document.createElement('span');
          span.textContent = val;
          flyStar.appendChild(span);
        });

        const yearDiv = document.createElement('div');
        yearDiv.className = 'flyingStartsYear';
        yearDiv.textContent = star.year;
        if (star.year === 5) yearDiv.classList.add('bg-red');
        flyStar.appendChild(yearDiv);

        const monthDiv = document.createElement('div');
        monthDiv.className = 'flyingStartsMonth';
        monthDiv.textContent = star.month;
        if (star.month === 5) monthDiv.classList.add('bg-red');
        flyStar.appendChild(monthDiv);

        if (
          fiveYMActive &&
          (star.year === 5 || star.month === 5)
        ) {
          item.classList.add('five-ym-sector');
        } else {
          item.classList.remove('five-ym-sector');
        }
      });
    }


    ymaps.ready(function () {
      function setupMap(coords, balloonContent) {
        map = new ymaps.Map("map", { center: coords, zoom: 10 });
        map.geoObjects.add(new ymaps.Placemark(coords, { balloonContent }));
        fetchCompassDataOnce(coords, cursorAngle);
        map.events.add('boundschange', function () {
        });
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position) {
            const userCoords = [position.coords.latitude, position.coords.longitude];
            setupMap(userCoords, "Вы здесь");
          },
          function () {
            const defaultCoords = [43.25368, 76.90275];
            setupMap(defaultCoords, "Алматы");
          }
        );
      } else {
        const defaultCoords = [43.25368, 76.90275];
        setupMap(defaultCoords, "Алматы");
      }
    });

    const compassItems = document.querySelector('.compass-back__items');
    const compassSectors = document.querySelector('.compass-sectors-wrapper');
    const compassGroup = document.getElementById('compass-group');
    const compassAngleInput = document.getElementById('compass-angle');
    compassAngleInput.addEventListener('input', () => {
      const angle = Number(compassAngleInput.value) || 0;
      compassGroup.setAttribute('transform', `rotate(${angle},180,180)`);
      compassItems.style.transform = `rotate(${angle}deg)`;
      setCursorAngle(cursorAngle);
      updateCabins(angle);
    });

    const cursorGroup = document.getElementById('cursor-group');
    const cursorHead = document.getElementById('cursor-head');
    let dragging = false;

    function setCursorAngle(angle) {
      cursorAngle = angle;
      cursorGroup.setAttribute('transform', `rotate(${cursorAngle},180,180)`);
      const compassAngle = Number(compassAngleInput.value) || 0;
      let displayAngle = (cursorAngle - compassAngle + 360) % 360;
      document.getElementById('cursor-angle-label').textContent = `${Math.round(displayAngle)}°`;
      if (starsData) {
        fillCompassItems(
          transformStarsToCompassArray(
            starsData.stars,
            starsData.year_stars,
            starsData.month_stars,
            getSectorFromAngle(cursorAngle)
          )
        );
      }
    }
    setCursorAngle(cursorAngle);

    function getAngleFromCenter(clientX, clientY) {
      const rect = document.getElementById('compass-svg').getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const dx = clientX - cx;
      const dy = clientY - cy;
      let angle = Math.atan2(dy, dx) * 180 / Math.PI;
      angle = (angle + 90 + 360) % 360;
      return angle;
    }

    cursorHead.addEventListener('mousedown', function (e) {
      e.preventDefault();
      dragging = true;
      document.body.style.userSelect = "none";
    });

    window.addEventListener('mousemove', function (e) {
      if (!dragging) return;
      const angle = getAngleFromCenter(e.clientX, e.clientY);
      setCursorAngle(angle);
    });

    window.addEventListener('mouseup', function () {
      dragging = false;
      document.body.style.userSelect = "";
    });

    cursorHead.addEventListener('touchstart', function (e) {
      e.preventDefault();
      dragging = true;
      document.body.style.userSelect = "none";
    });

    window.addEventListener('touchmove', function (e) {
      if (!dragging) return;
      const touch = e.touches[0];
      const angle = getAngleFromCenter(touch.clientX, touch.clientY);
      setCursorAngle(angle);
    });

    window.addEventListener('touchend', function () {
      dragging = false;
      document.body.style.userSelect = "";
    });

    function updateCabins(compassAngle) {
      const items = document.querySelectorAll('.compass-back__item');
      items.forEach(item => {
        item.style.transform = `rotate(${-compassAngle}deg)`;
      });
    }

    function updateFlyingStarsVisibility() {
      const natalCheckbox = document.getElementById('FStarsN');
      const yearCheckbox = document.getElementById('FStarsY');
      const monthCheckbox = document.getElementById('FStarsM');
      const centerCheckbox = document.getElementById('FStarsC');

      document.querySelectorAll('.fly-star').forEach(el => {
        if (!natalCheckbox.checked) {
          el.classList.add('fly-star--hidden');
        } else {
          el.classList.remove('fly-star--hidden');
        }
      });

      document.querySelectorAll('.flyingStartsYear').forEach(el => {
        el.style.display = yearCheckbox.checked ? '' : 'none';
      });

      document.querySelectorAll('.flyingStartsMonth').forEach(el => {
        el.style.display = monthCheckbox.checked ? '' : 'none';
      });

      document.querySelector('.compass-back__item--center').style.display = centerCheckbox.checked ? '' : 'none';
    }

    document.getElementById('FStarsN').addEventListener('change', updateFlyingStarsVisibility);
    document.getElementById('FStarsY').addEventListener('change', updateFlyingStarsVisibility);
    document.getElementById('FStarsM').addEventListener('change', updateFlyingStarsVisibility);
    document.getElementById('FStarsC').addEventListener('change', updateFlyingStarsVisibility);

    updateFlyingStarsVisibility();

    let taiSuiActive = false;

    document.getElementById('TaiSui').addEventListener('change', function () {
      taiSuiActive = this.checked;
      updateTaiSuiHighlight();
    });

    function updateTaiSuiHighlight() {
      document.querySelectorAll('.compass-sector').forEach(sector => {
        sector.classList.remove('tai-sui-sector-highlight');
      });

      if (!taiSuiActive || !starsData) return;

      const s1 = starsData.sector_1;
      const s2 = starsData.sector_2;
      [s1, s2].forEach(name => {
        if (!name) return;
        document.querySelector(`.compass-sector.${name}`)?.classList.add('tai-sui-sector-highlight');
      });
    }

    let fiveYMActive = false;
    document.getElementById('fiveYM').addEventListener('change', function () {
      fiveYMActive = this.checked;
      setCursorAngle(cursorAngle);
      updateFiveYMHighlight();
    });

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("width", 360);
    svg.setAttribute("height", 360);
    svg.setAttribute("viewBox", "0 0 360 360");
    svg.setAttribute("class", "compass-sectors");
    svg.style.position = "absolute";
    svg.style.top = "0";
    svg.style.left = "0";
    svg.style.pointerEvents = "none";
    svg.style.zIndex = 10;

    const sectorNames = [
      'n1', 'n2', 'n3',         // Север
      'ne1', 'ne2', 'ne3',     // Северо-восток
      'e1', 'e2', 'e3',        // Восток
      'se1', 'se2', 'se3',     // Юго-восток
      's1', 's2', 's3',        // Юг
      'sw1', 'sw2', 'sw3',     // Юго-запад
      'w1', 'w2', 'w3',        // Запад
      'nw1', 'nw2', 'nw3'      // Северо-запад
    ];

    for (let i = 0; i < 24; i++) {
      const angle1 = (i * 15 - 90 - 24) * Math.PI / 180;
      const angle2 = ((i + 1) * 15 - 90 - 24) * Math.PI / 180;
      const r = 180, cx = 180, cy = 180;
      const x1 = cx + r * Math.cos(angle1);
      const y1 = cy + r * Math.sin(angle1);
      const x2 = cx + r * Math.cos(angle2);
      const y2 = cy + r * Math.sin(angle2);

      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d",
        `M${cx},${cy} L${x1},${y1} A${r},${r} 0 0,1 ${x2},${y2} Z`
      );
      path.setAttribute("fill", "red");
      path.setAttribute("fill-opacity", "0");
      path.setAttribute("class", "compass-sector " + sectorNames[i]);
      path.setAttribute("data-sector", sectorNames[i]);
      svg.appendChild(path);
    }

    document.querySelector('.compass-sectors-wrapper').appendChild(svg);


    function updateFiveYMHighlight() {
      document.querySelectorAll('.compass-sector').forEach(sector => {
        sector.classList.remove('five-ym-highlight');
      });

      if (!fiveYMActive || !starsData) return;

      const allDirs = ['n', 'ne', 'e', 'se', 's', 'sw', 'w', 'nw'];
      const found = new Set();

      for (const dir of allDirs) {
        if (starsData.year_stars[dir] === 5 || starsData.month_stars[dir] === 5) {
          found.add(dir);
        }
      }

      found.forEach(dir => {
        for (let i = 1; i <= 3; i++) {
          const sectorName = `${dir}${i}`;
          document.querySelector(`.compass-sector.${sectorName}`)?.classList.add('five-ym-highlight');
        }
      });
    }




    // ПЛАН ПОМОЩЕНИЯ

    const el = document.getElementById('rotatable');
    let isDragging = false;
    let lastAngle = 0;
    let currentAngle = 0;
    let center = {};

    function getCenter(elem) {
      const rect = elem.getBoundingClientRect();
      return {
        x: rect.left + rect.width / 2,
        y: rect.top + rect.height / 2,
      };
    }

    function getAngle(x, y, center) {
      return Math.atan2(y - center.y, x - center.x) * 180 / Math.PI;
    }

    // Start (mouse/touch)
    function start(e) {
      isDragging = true;
      center = getCenter(el);
      let x, y;
      if (e.type.startsWith('touch')) {
        x = e.touches[0].clientX;
        y = e.touches[0].clientY;
      } else {
        x = e.clientX;
        y = e.clientY;
      }
      lastAngle = getAngle(x, y, center) - currentAngle;
      document.body.style.userSelect = "none";
    }

    // Move
    function move(e) {
      if (!isDragging) return;
      let x, y;
      if (e.type.startsWith('touch')) {
        x = e.touches[0].clientX;
        y = e.touches[0].clientY;
      } else {
        x = e.clientX;
        y = e.clientY;
      }
      const angle = getAngle(x, y, center);
      currentAngle = angle - lastAngle;
      el.style.transform = `rotate(${currentAngle}deg)`;
    }

    // End
    function end() {
      isDragging = false;
      document.body.style.userSelect = "";
    }

    // Events
    el.addEventListener('mousedown', start);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);

    el.addEventListener('touchstart', start);
    window.addEventListener('touchmove', move);
    window.addEventListener('touchend', end);

  });
</script>
<!-- 
<script>
  flatpickr("#rangePicker", {
    locale: "ru",
    dateFormat: "d.m"
  });
</script> -->