<!--#set var="title" value="OptimizedHTML 5" -->
<!--#include virtual="./parts/header.html" -->
<div class="page page__bg page__compas">
  <!--#include virtual="./parts/head.html" -->

  <div id="map"></div>
  <div class="plan-back" style="display: none;">
    <img src="../images/dist/plan-back.svg" alt="">
  </div>
  <div class="plan-front" style="display: none;">
    <img src="../images/dist/plan-front.svg" alt="">
  </div>
  <div class="rotatable" id="rotatable">

    <!-- <img src="../images/dist/plan-example.png" alt=""> -->
  </div>
  <div id="compass-wrap">
    <svg id="compass-svg" width="360" height="360" viewBox="0 0 360 360">
      <!-- Картинка компаса -->
      <g id="compass-group">
        a
        <image href="../images/dist/compas.png" x="0" y="0" width="360" height="360" />
      </g>
      <!-- Красный курсор (стрелка) -->
      <g id="cursor-group">
        <line x1="180" y1="180" x2="180" y2="0" stroke="red" stroke-width="2" stroke-linecap="round" />
        <!-- Горизонтальная перекладина в центре -->
        <line x1="140" y1="180" x2="220" y2="180" stroke="red" stroke-width="2" stroke-linecap="round" />
        <!-- Прямоугольник (голова с градусом) -->
        <rect id="cursor-head" x="155" y="0" width="50" height="32" rx="6" fill="red" />
        <!-- Текст угла -->
        <text id="cursor-angle-label" x="180" y="20" text-anchor="middle" fill="white" font-size="20"
          font-family="sans-serif" alignment-baseline="middle" font-weight="bold">0°</text>
      </g>


    </svg>
  </div>
  <div class="compass-back">

    <div class="compass-back__items">
      <div class="compass-sectors-wrapper"></div>
      <div id="n" class="compass-back__item compass-back__item--1">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>
      <div id="ne" class="compass-back__item compass-back__item--2">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="e" class="compass-back__item compass-back__item--3">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="se" class="compass-back__item compass-back__item--4">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="s" class="compass-back__item compass-back__item--5">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="sw" class="compass-back__item compass-back__item--6">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="w" class="compass-back__item compass-back__item--7">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="nw" class="compass-back__item compass-back__item--8">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>

      <div id="center" class="compass-back__item compass-back__item--center">
        <div class="fly-star">
          <span></span>
          <span></span>
          <span></span>
          <div class="flyingStartsYear"></div>
          <div class="flyingStartsMonth"></div>
        </div>
      </div>
    </div>
  </div>
  <a href="" class="compass__settings-btn" data-modal-open="modalExample">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"
      class="lucide lucide-settings2-icon lucide-settings-2">
      <path d="M14 17H5" />
      <path d="M19 7h-9" />
      <circle cx="17" cy="17" r="3" />
      <circle cx="7" cy="7" r="3" />
    </svg>
    Параметры
  </a>
  <div id="modalExample" class="modal">
    <div class="modal__overlay" data-modal-close></div>
    <div class="modal__content" data-city-search="from" data-hidden-input="#hidden-from">
      <button class="modal__close" data-modal-close></button>
      <h2 class="modal__title">Параметры</h2>
      <div id="ui" class="compass-field-wrapper">
        <label for="compass-angle">Повернуть компас:</label> <input id="compass-angle" class="compass-field"
          type="number" value="0" step="1" min="0" max="359"> °
      </div>
      <div class="compass-field-wrapper">
        <label for="CSYear">Текущий год:</label> <input id="CSYear" class="compass-field" type="number" step="1"
          value="2023">
      </div>
      <!-- <div class="compass-field-wrapper">
        <label for="rangePicker">Текущий месяц:</label> <input type="text" id="rangePicker" class="compass-field"
          placeholder="Дата" readonly>
      </div> -->
      <div class="compass-field-wrapper">
        <label for="CSMonth">Текущий месяц:</label>

        <select name="" id="CSMonth" class="compass-field">
          <option value="">12/08</option>
          <option value="">12/08</option>
          <option value="">12/08</option>
          <option value="">12/08</option>
        </select>
      </div>
      <div class="compass-field-wrapper">
        <label for="builtYear">Год постройки:</label> <input id="builtYear" class="compass-field" type="number" step="1"
          value="2023">
      </div>
      <div class="compass-field-wrapper">
        <label for="periodInput">Период:</label>
        <input id="periodInput" class="compass-field" type="number" min="1" max="9" value="9">
      </div>
      <div class="checkbox-wrapper">
        <input type="checkbox" class="CheckBox" id="compas-visible" name="compas-visible" checked>
        <label for="compas-visible">Шаблон 24 гор</label>
      </div>
      <div id="DegreeCorret" class="FormBlock">

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="FStarsN" name="FStarsN" checked>
          <label for="FStarsN">Натальные летящие звезды</label>
        </div>

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="FStarsY" name="FStarsY" checked>
          <label for="FStarsY">Текущие звезды <b>года</b></label>
        </div>

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="FStarsM" name="FStarsM" checked>
          <label for="FStarsM">Текущие звезды <b>месяца</b></label>
        </div>

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="FStarsC" name="FStarsC">
          <label for="FStarsC">Центральные летящие звезды</label>
        </div>
        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="fiveYM" name="fiveYM">
          <label for="fiveYM">Направления 5 года и месяца</label>
        </div>

        <div class="checkbox-wrapper">
          <input type="checkbox" class="CheckBox" id="TaiSui" name="TaiSui">
          <label for="TaiSui">Тай Суй и Суй По</label>
        </div>

      </div>

      <label class="file-label">
        <input type="file" class="file-input" id="file-input">
        <span class="file-custom">Загрузить план</span>
      </label>
      <button class="modal__save-btn" data-modal-close>Сохранить</button>
      <button class="modal__close" data-modal-close></button>
    </div>
  </div>
  <!--#include virtual="./parts/nav.html" -->
</div>
<!--#include virtual="./parts/footer.html" -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=21e9bb68-c626-48cd-9ec6-caba33922726&lang=ru_RU"
  type="text/javascript"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const replacementStarsUrl = './starsMockData.json';
    let map;
    let cursorAngle = 0;
    let lastCoords = null;
    let debounceTimeout = null;
    let starsData = null;
    let change = null;
    const url_coordinate = "{% url 'get_magnetic_declination' %}";

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    document.getElementById('CSYear').value = currentYear;
    document.getElementById('builtYear').value = currentYear;
    document.getElementById('periodInput').value = 9;
    document.getElementById('CSMonth').value = currentMonth;
    const ids = ['periodInput', 'CSYear', 'builtYear', 'CSMonth'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('change', () => {
          const coords = { x: 0, y: 0 };
          const angle = 0;
          if (id === 'periodInput') {
            change = 'period';
          } else if (id === 'builtYear') {
            change = 'year_built';
          } else {
            change = null;
          }
          fetchCompassDataOnce(coords, angle);
        });
      }
    });

    const checkbox = document.getElementById('compas-visible');
    const compass = document.getElementById('compass-group');

    checkbox.addEventListener('change', function () {
      if (checkbox.checked) {
        compass.style.display = 'inline';
      } else {
        compass.style.display = 'none';
      }
    });

    compass.style.display = checkbox.checked ? 'inline' : 'none';

    function fetchCompassDataOnce(coords, cursorAngle) {
      const period = Number(document.getElementById('periodInput').value) || 9;
      const year = Number(document.getElementById('CSYear').value) || new Date().getFullYear();
      const year_built = Number(document.getElementById('builtYear').value) || new Date().getFullYear();
      const month = document.getElementById('CSMonth').value;

      fetch(`${replacementStarsUrl}?period=${period}&year=${year}&month=${month}&year_built=${year_built}&change=${change}`)
        .then(response => {
          if (!response.ok) throw new Error('Ошибка загрузки звёзд');
          return response.json();
        })
        .then(data => {
          console.log(data)
          if (data.period !== undefined) {
            document.getElementById('periodInput').value = data.period;
          }
          if (data.year !== undefined) {
            document.getElementById('CSYear').value = data.year;
          }
          if (data.year_built !== undefined) {
            document.getElementById('builtYear').value = data.year_built;
          }
          if (data.month !== undefined) {
            document.getElementById('CSMonth').value = data.month;
          }
          starsData = data;
          setCursorAngle(cursorAngle);
          updateFiveYMHighlight();
          updateTaiSuiHighlight();
          change = null;

        })
        .catch(err => {
          console.error('Ошибка получения данных:', err);
        });
    }

    function getSectorFromAngle(angle) {
      const input = document.getElementById('compass-angle');
      if (!input) {
        console.warn('Элемент #compass-angle не найден');
        return;
      }

      const declination = parseFloat(input.value) || 0
      const angleDec = angle - declination
      const normalized = (angleDec % 360 + 360) % 360;  // нормализуем угол

      const sectors = [
        { name: 's1', from: 157.6, to: 172.5 },
        { name: 's2', from: 172.6, to: 187.5 },
        { name: 's3', from: 187.6, to: 202.5 },
        { name: 'sw1', from: 202.6, to: 217.5 },
        { name: 'sw2', from: 217.6, to: 232.5 },
        { name: 'sw3', from: 232.6, to: 247.5 },
        { name: 'w1', from: 247.6, to: 262.5 },
        { name: 'w2', from: 262.6, to: 277.5 },
        { name: 'w3', from: 277.6, to: 292.5 },
        { name: 'nw1', from: 292.6, to: 307.5 },
        { name: 'nw2', from: 307.6, to: 322.5 },
        { name: 'nw3', from: 322.6, to: 337.5 },
        { name: 'n1', from: 337.6, to: 352.5 },
        { name: 'n2', from: 352.6, to: 7.5 },
        { name: 'n3', from: 7.6, to: 22.5 },
        { name: 'ne1', from: 22.6, to: 37.5 },
        { name: 'ne2', from: 37.6, to: 52.5 },
        { name: 'ne3', from: 52.6, to: 67.5 },
        { name: 'e1', from: 67.6, to: 82.5 },
        { name: 'e2', from: 82.6, to: 97.5 },
        { name: 'e3', from: 97.6, to: 112.5 },
        { name: 'se1', from: 112.6, to: 127.5 },
        { name: 'se2', from: 127.6, to: 142.5 },
        { name: 'se3', from: 142.6, to: 157.5 }
      ];

      for (const sector of sectors) {
        if (sector.from < sector.to) {
          if (normalized >= sector.from && normalized <= sector.to) {
            return sector.name;
          }
        } else {
          if (normalized >= sector.from || normalized <= sector.to) {
            return sector.name;
          }
        }
      }

      return 's1';
    }

    function transformStarsToCompassArray(starsRaw, years, months, sectorKey) {
      const directionOrder = ['n', 'ne', 'e', 'se', 's', 'sw', 'w', 'nw', 'center'];
      const cursorData = starsRaw[sectorKey];
      if (!cursorData) return [];
      return directionOrder.map(dir => ({
        sector: dir,
        values: cursorData[dir] || [],
        year: years[dir],
        month: months[dir]
      }));
    }

    function fillCompassItems(stars) {
      stars.forEach(star => {
        const item = document.getElementById(`${star.sector}`);
        ;
        if (!item) return;
        const flyStar = item.querySelector('.fly-star');
        if (!flyStar) return;

        flyStar.innerHTML = '';

        star.values.forEach(val => {
          const span = document.createElement('span');
          span.textContent = val;
          flyStar.appendChild(span);
        });

        const yearDiv = document.createElement('div');
        yearDiv.className = 'flyingStartsYear';
        yearDiv.textContent = star.year;
        if (star.year == 5 | star.year == "5") yearDiv.classList.add('bg-red');
        flyStar.appendChild(yearDiv);

        const monthDiv = document.createElement('div');
        monthDiv.className = 'flyingStartsMonth';
        monthDiv.textContent = star.month;
        if (star.month === 5 | star.month == "5") monthDiv.classList.add('bg-red');
        flyStar.appendChild(monthDiv);

        const sectorNameDiv = document.createElement('div');
        sectorNameDiv.className = 'flyingSectorName';
        sectorNameDiv.textContent = star.sector;
        flyStar.appendChild(sectorNameDiv);

        if (
          fiveYMActive &&
          (star.year === 5 || star.month === 5)
        ) {
          item.classList.add('five-ym-sector');
        } else {
          item.classList.remove('five-ym-sector');
        }

      });
    }

    ymaps.ready(function () {
      function setupMap(coords, balloonContent) {
        map = new ymaps.Map("map", { center: coords, zoom: 10 });
        map.geoObjects.add(new ymaps.Placemark(coords, { balloonContent }));

        fetchCompassDataOnce(coords, cursorAngle);

        map.events.add('boundschange', function () {
        });
      }

      navigator.geolocation.getCurrentPosition(
        function (position) {
          console.log('[geo] ✅ Координаты получены:', position.coords);
        },
        function (error) {
          console.warn('[geo] ❌ Ошибка геолокации:', error.message);
        }
      );

      if (navigator.geolocation) {
        console.log('[geo] Геолокация поддерживается');
        console.log(url_coordinate)
        navigator.geolocation.getCurrentPosition(
          function (position) {
            console.log('[geo] Координаты получены:', position.coords);
            const userCoords = [position.coords.latitude, position.coords.longitude];
            setupMap(userCoords, "Вы здесь");

            fetch(`${url_coordinate}?lat=${userCoords[0]}&lon=${userCoords[1]}`)
              .then(res => res.json())
              .then(data => {
                console.log('Склонение получено:', data); // <---- Вставка
                if (data.declination !== undefined) {
                  const compassInput = document.getElementById('compass-angle');
                  console.log('Найден input:', compassInput); // <---- Проверка input
                  compassInput.value = data.declination;
                  const declination = data.declination;
                  compassInput.dispatchEvent(new Event('input'));
                }
              })
              .catch(err => {
                console.error('Ошибка получения склонения:', err);
              });

          },
          function () {
            const defaultCoords = [43.25368, 76.90275];
            setupMap(defaultCoords, "Алматы");
          }
        );
      } else {
        const defaultCoords = [43.25368, 76.90275];
        setupMap(defaultCoords, "Алматы");
      }
    });

    const compassItems = document.querySelector('.compass-back__items');
    const compassSectors = document.querySelector('.compass-sectors-wrapper');

    const compassGroup = document.getElementById('compass-group');
    const compassAngleInput = document.getElementById('compass-angle');
    compassAngleInput.addEventListener('input', () => {
      const angle = Number(compassAngleInput.value) || 0;
      compassGroup.setAttribute('transform', `rotate(${angle},180,180)`);
      compassItems.style.transform = `rotate(${angle}deg)`;
      setCursorAngle(cursorAngle);
      updateCabins(angle);
    });

    const cursorGroup = document.getElementById('cursor-group');
    const cursorHead = document.getElementById('cursor-head');
    let dragging = false;

    function setCursorAngle(angle) {
      cursorAngle = angle;
      cursorGroup.setAttribute('transform', `rotate(${cursorAngle},180,180)`);
      const compassAngle = Number(compassAngleInput.value) || 0;
      let displayAngle = (cursorAngle - compassAngle + 360) % 360;
      document.getElementById('cursor-angle-label').textContent = `${Math.round(displayAngle)}°`;
      if (starsData) {
        fillCompassItems(
          transformStarsToCompassArray(
            starsData.stars,
            starsData.year_stars,
            starsData.month_stars,
            getSectorFromAngle(cursorAngle)
          )
        );
      }
    }

    setCursorAngle(cursorAngle);

    function getAngleFromCenter(clientX, clientY) {
      const rect = document.getElementById('compass-svg').getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const dx = clientX - cx;
      const dy = clientY - cy;
      let angle = Math.atan2(dy, dx) * 180 / Math.PI;
      angle = (angle + 90 + 360) % 360;
      return angle;
    }
    let clientX = null;
    let clientY = null;
    cursorHead.addEventListener('mousedown', function (e) {
      e.preventDefault();
      dragging = true;
      document.body.style.userSelect = "none";
    });

    window.addEventListener('mousemove', function (e) {
      if (!dragging) return;
      const angle = getAngleFromCenter(e.clientX, e.clientY);
      currentAngle = angle
      setCursorAngle(angle);
    });

    window.addEventListener('mouseup', function () {
      dragging = false;
      document.body.style.userSelect = "";
    });

    cursorHead.addEventListener('touchstart', function (e) {
      e.preventDefault();
      dragging = true;
      document.body.style.userSelect = "none";
    });

    window.addEventListener('touchmove', function (e) {
      if (!dragging) return;
      const touch = e.touches[0];
      const angle = getAngleFromCenter(touch.clientX, touch.clientY);
      currentAngle = angle
      setCursorAngle(angle);
    });

    window.addEventListener('touchend', function () {
      dragging = false;
      document.body.style.userSelect = "";
    });

    function updateCabins(compassAngle) {
      const items = document.querySelectorAll('.compass-back__item');
      items.forEach(item => {
        item.style.transform = `rotate(${-compassAngle}deg)`;
      });
    }

    function updateFlyingStarsVisibility() {
      const natalCheckbox = document.getElementById('FStarsN');
      const yearCheckbox = document.getElementById('FStarsY');
      const monthCheckbox = document.getElementById('FStarsM');
      const centerCheckbox = document.getElementById('FStarsC');

      document.querySelectorAll('.fly-star').forEach(el => {
        if (!natalCheckbox.checked) {
          el.classList.add('fly-star--hidden');
        } else {
          el.classList.remove('fly-star--hidden');
        }
      });

      document.querySelectorAll('.flyingStartsYear').forEach(el => {
        el.style.display = yearCheckbox.checked ? '' : 'none';
      });

      document.querySelectorAll('.flyingStartsMonth').forEach(el => {
        el.style.display = monthCheckbox.checked ? '' : 'none';
      });

      document.querySelector('.compass-back__item--center').style.display = centerCheckbox.checked ? '' : 'none';
    }

    document.getElementById('FStarsN').addEventListener('change', updateFlyingStarsVisibility);
    document.getElementById('FStarsY').addEventListener('change', updateFlyingStarsVisibility);
    document.getElementById('FStarsM').addEventListener('change', updateFlyingStarsVisibility);
    document.getElementById('FStarsC').addEventListener('change', updateFlyingStarsVisibility);


    updateFlyingStarsVisibility();
    let taiSuiActive = false;

    document.getElementById('TaiSui').addEventListener('change', function () {
      taiSuiActive = this.checked;
      updateTaiSuiHighlight();
    });

    function updateTaiSuiHighlight() {
      document.querySelectorAll('.compass-sector').forEach(sector => {
        sector.classList.remove('tai-sui-sector-highlight');
      });

      if (!taiSuiActive || !starsData) return;

      const s1 = starsData.sector_1;
      const s2 = starsData.sector_2;
      [s1, s2].forEach(name => {
        if (!name) return;
        document.querySelector(`.compass-sector.${name}`)?.classList.add('tai-sui-sector-highlight');
      });
    }

    let fiveYMActive = false;
    document.getElementById('fiveYM').addEventListener('change', function () {
      fiveYMActive = this.checked;
      setCursorAngle(cursorAngle);
      updateFiveYMHighlight();
      updateFlyingStarsVisibility();
    });

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("width", 360);
    svg.setAttribute("height", 360);
    svg.setAttribute("viewBox", "0 0 360 360");
    svg.setAttribute("class", "compass-sectors");
    svg.style.position = "absolute";
    svg.style.top = "0";
    svg.style.left = "0";
    svg.style.pointerEvents = "none";
    svg.style.zIndex = 10;

    const sectorNames = [
      'n1', 'n2', 'n3',         // Север
      'ne1', 'ne2', 'ne3',     // Северо-восток
      'e1', 'e2', 'e3',        // Восток
      'se1', 'se2', 'se3',     // Юго-восток
      's1', 's2', 's3',        // Юг
      'sw1', 'sw2', 'sw3',     // Юго-запад
      'w1', 'w2', 'w3',        // Запад
      'nw1', 'nw2', 'nw3'      // Северо-запад
    ];

    for (let i = 0; i < 24; i++) {
      const angle1 = (i * 15 - 90 - 24) * Math.PI / 180;
      const angle2 = ((i + 1) * 15 - 90 - 24) * Math.PI / 180;
      const r = 180, cx = 180, cy = 180;
      const x1 = cx + r * Math.cos(angle1);
      const y1 = cy + r * Math.sin(angle1);
      const x2 = cx + r * Math.cos(angle2);
      const y2 = cy + r * Math.sin(angle2);

      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d",
        `M${cx},${cy} L${x1},${y1} A${r},${r} 0 0,1 ${x2},${y2} Z`
      );
      path.setAttribute("fill", "red");
      path.setAttribute("fill-opacity", "0");
      path.setAttribute("class", "compass-sector " + sectorNames[i]);
      path.setAttribute("data-sector", sectorNames[i]);
      svg.appendChild(path);
    }

    document.querySelector('.compass-sectors-wrapper').appendChild(svg);


    function updateFiveYMHighlight() {
      document.querySelectorAll('.compass-sector').forEach(sector => {
        sector.classList.remove('five-ym-highlight');
      });

      if (!fiveYMActive || !starsData) return;

      const allDirs = ['n', 'ne', 'e', 'se', 's', 'sw', 'w', 'nw'];
      const found = new Set();

      for (const dir of allDirs) {
        if (starsData.year_stars[dir] === 5 || starsData.month_stars[dir] === 5) {
          found.add(dir);
        }
      }

      found.forEach(dir => {
        for (let i = 1; i <= 3; i++) {
          const sectorName = `${dir}${i}`;
          document.querySelector(`.compass-sector.${sectorName}`)?.classList.add('five-ym-highlight');
        }
      });
      updateFlyingStarsVisibility();
    }

    // ПЛАН ПОМОЩЕНИЯ

    const el = document.getElementById('rotatable');
    let isDragging = false;
    let lastAngle = 0;
    let currentAngle = 0;
    let center = {};

    document.getElementById('file-input').addEventListener('change', function (event) {
      const file = event.target.files[0];

      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();

        reader.onload = function (e) {
          const rotatableDiv = document.getElementById('rotatable');
          rotatableDiv.innerHTML = '';

          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = 'Загруженное изображение';

          rotatableDiv.appendChild(img);

          // Скрыть компас
          const cursorGroup = document.getElementById('cursor-group');
          if (cursorGroup) cursorGroup.style.display = 'none';

          // Показать план
          const planBack = document.querySelector('.plan-back');
          const planFront = document.querySelector('.plan-front');
          if (planBack) planBack.style.display = 'block';
          if (planFront) planFront.style.display = 'block';

          // Добавить класс with-plan
          const compassBack = document.querySelector('.compass-back');
          if (compassBack) compassBack.classList.add('with-plan');
          const compassGroupPlan = document.getElementById('compass-group');
          const compassItemsPlan = document.querySelector('.compass-back__items');
          const input = document.getElementById('compass-angle');
          const inputValue = Number(input.value) || 0;
          angle = (180 - (currentAngle - inputValue) + 360) % 360;

          const planItems = compassItemsPlan.querySelectorAll('.compass-back__item');

          const degreeCorret = document.getElementById('DegreeCorret');
          const oldToggle = degreeCorret.querySelector('#toggle-plan');
          if (oldToggle && oldToggle.closest('.compass-field-wrapper')) {
            oldToggle.closest('.compass-field-wrapper').remove();
          }

          const wrapper = document.createElement('div');
          wrapper.className = 'compass-field-wrapper';


          const label = document.createElement('label');
          label.setAttribute('for', 'toggle-plan');
          label.textContent = 'Включить план:';

          const toggleInput = document.createElement('input');
          toggleInput.type = 'checkbox';
          toggleInput.className = 'compass-field';
          toggleInput.id = 'toggle-plan';
          toggleInput.checked = true;

          wrapper.appendChild(label);
          wrapper.appendChild(toggleInput);

          degreeCorret.appendChild(wrapper);

          function handlePlanToggle() {
            const isChecked = toggleInput.checked;

            const cursorGroup = document.getElementById('cursor-group');
            const planBack = document.querySelector('.plan-back');
            const planFront = document.querySelector('.plan-front');
            const compassBack = document.querySelector('.compass-back');

            if (isChecked) {
              console.log('checked')
              if (cursorGroup) cursorGroup.style.display = 'none';
              if (planBack) planBack.style.display = 'block';
              if (planFront) planFront.style.display = 'block';
              if (compassBack) compassBack.classList.add('with-plan');
              if (img) img.style.display = 'block';
              const rotateTo = 180 - cursorAngle;
              if (compassGroupPlan) compassGroupPlan.setAttribute('transform', `rotate(${rotateTo},180,180)`);
              if (compassItemsPlan) compassItemsPlan.style.transform = `rotate(${rotateTo}deg)`;
              updateCabins(rotateTo)
            } else {
              if (cursorGroup) cursorGroup.style.display = 'block';
              if (planBack) planBack.style.display = 'none';
              if (planFront) planFront.style.display = 'none';
              if (compassBack) compassBack.classList.remove('with-plan');
              if (img) img.style.display = 'none';

              if (compassGroupPlan) compassGroupPlan.setAttribute('transform', `rotate(0,180,180)`);
              if (compassItemsPlan) compassItemsPlan.style.transform = `rotate(0deg)`;

              updateCabins(0)
            }
          }
          handlePlanToggle();
          toggleInput.addEventListener('change', function () {
            handlePlanToggle();
          });
        };

        reader.readAsDataURL(file);
      } else {
        alert('Пожалуйста, выберите изображение');
      }
    });

    function getCenter(elem) {
      const rect = elem.getBoundingClientRect();
      return {
        x: rect.left + rect.width / 2,
        y: rect.top + rect.height / 2,
      };
    }

    function getAngle(x, y, center) {
      return Math.atan2(y - center.y, x - center.x) * 180 / Math.PI;
    }

    function start(e) {
      isDragging = true;
      center = getCenter(el);
      let x, y;
      if (e.type.startsWith('touch')) {
        x = e.touches[0].clientX;
        y = e.touches[0].clientY;
      } else {
        x = e.clientX;
        y = e.clientY;
      }
      lastAngle = getAngle(x, y, center) - currentAngle;
      document.body.style.userSelect = "none";
    }

    function move(e) {
      if (!isDragging) return;
      let x, y;
      if (e.type.startsWith('touch')) {
        x = e.touches[0].clientX;
        y = e.touches[0].clientY;
      } else {
        x = e.clientX;
        y = e.clientY;
      }
      const angle = getAngle(x, y, center);
      currentAngle = angle - lastAngle;
      el.style.transform = `rotate(${currentAngle}deg)`;
    }


    function end() {
      isDragging = false;
      document.body.style.userSelect = "";
    }


    el.addEventListener('mousedown', start);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);

    el.addEventListener('touchstart', start);
    window.addEventListener('touchmove', move);
    window.addEventListener('touchend', end);
  });


</script>
<!-- 
<script>
  flatpickr("#rangePicker", {
    locale: "ru",
    dateFormat: "d.m"
  });
</script> -->